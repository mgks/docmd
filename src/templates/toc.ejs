<%# Source file from the docmd project â€” https://github.com/docmd-io/docmd %>

<% 
function decodeHtmlEntities(html) {
  return html.replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"').replace(/&#39;/g, "'").replace(/&nbsp;/g, ' ');
}
const shouldShowToc = typeof isActivePage !== 'undefined' ? isActivePage : 
                      (typeof navigationHtml !== 'undefined' && navigationHtml && navigationHtml.includes('class="active"'));

if (shouldShowToc && !frontmatter?.toc || frontmatter?.toc !== 'false') {
  let tocHeadings = [];
  if (headings && headings.length > 0) {
    tocHeadings = headings.filter(h => h.level >= 2 && h.level <= 4);
  } else if (content) {
    const headingRegex = /<h([2-4])[^>]*?(?:id="([^"]*)")?[^>]*?>([\s\S]*?)<\/h\1>/g;
    let match;
    let contentStr = content.toString();
    while ((match = headingRegex.exec(contentStr)) !== null) {
      const level = parseInt(match[1], 10);
      let id = match[2];
      const text = decodeHtmlEntities(match[3].replace(/<\/?\w+[^>]*>/g, '')); // Stripped tags
      if (!id) id = text.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]/g, '').replace(/--+/g, '-').replace(/^-+|-+$/g, '');
      tocHeadings.push({ id, level, text });
    }
  }
  if (tocHeadings.length > 1) { 
%>
  <div class="toc-container">
    <h2 class="toc-title">On This Page<span class="mobile-view toc-menu-button float-right"><%- renderIcon("chevrons-down-up") %></span></h2>
    <ul class="toc-list">
      <% tocHeadings.forEach(heading => { %>
        <li class="toc-item toc-level-<%= heading.level %>">
          <a href="#<%= heading.id %>" class="toc-link"><%- heading.text %></a>
        </li>
      <% }); %>
    </ul>
  </div>
<% } } %>