<%# Source file from the docmd project â€” https://github.com/docmd-io/docmd %>

<nav class="sidebar-nav" aria-label="Main navigation">
  <ul>
    <%
      function normalizePath(p) {
        if (!p) return '#';
        if (p.startsWith('http://') || p.startsWith('https://')) return p;
        let path = p.replace(/\\/g, '/');
        if (path.startsWith('./')) path = path.substring(2);
        if (path.endsWith('index.md')) path = path.slice(0, -'index.md'.length);
        else path = path.replace(/\.md$/, '');
        if (!path.startsWith('/')) path = '/' + path;
        if (path.length > 1 && !path.endsWith('/')) path += '/';
        if (path === '') path = '/';
        return path;
      }

      function hasActiveChild(item, currentPagePath) {
        if (!item.children || !Array.isArray(item.children)) return false;
        return item.children.some(child => {
          if (!child.path || child.external) return false;
          const childPath = normalizePath(child.path);
          if (currentPagePath === childPath) return true;
          return hasActiveChild(child, currentPagePath);
        });
      }

      function renderNav(items) {
        if (!items || !Array.isArray(items)) return;
        items.forEach(item => {
          const isExplicitExternal = item.external || false;
          let itemPath = item.path || '#';
          const isAbsoluteUrl = itemPath.startsWith('http://') || itemPath.startsWith('https://');
          const normalizedItemPath = (isExplicitExternal || isAbsoluteUrl) ? itemPath : normalizePath(itemPath);
          const isActive = !isExplicitExternal && !isAbsoluteUrl && currentPagePath === normalizedItemPath;
          const isParentOfActive = !isActive && hasActiveChild(item, currentPagePath);
          const isCollapsible = item.children && item.collapsible;
          const shouldBeOpen = isParentOfActive || (isActive && item.children && item.children.length > 0);
          const liClasses = [];
          if (isActive) liClasses.push('active');
          if (isParentOfActive) liClasses.push('active-parent');
          if (isCollapsible) liClasses.push('collapsible');
          let liAttributes = `class="${liClasses.join(' ')}"`;
          if (isCollapsible) {
              liAttributes += ` data-nav-id="${item.path}"`;
              if (shouldBeOpen) liAttributes += ` aria-expanded="true"`;
          }
          let finalHref = item.path;
          if (!isExplicitExternal && !isAbsoluteUrl) {
             if (!itemPath || itemPath === '#') {
                 finalHref = '#';
             } else {
                 let cleanPath = item.path;
                 if (cleanPath.startsWith('/')) cleanPath = cleanPath.substring(1);
                 finalHref = relativePathToRoot + cleanPath;
                 const offline = (typeof locals !== 'undefined' && locals.isOfflineMode) === true;
                 if (offline) {
                     if (finalHref.endsWith('/')) finalHref += 'index.html';
                     else if (finalHref === './') finalHref = './index.html';
                     else if (!finalHref.includes('#')) {
                         const parts = finalHref.split('?')[0].split('/'); 
                         const lastSegment = parts[parts.length - 1];
                         if (!lastSegment.includes('.')) finalHref += '/index.html';
                     }
                 } else {
                     if (finalHref.endsWith('/index.html')) finalHref = finalHref.substring(0, finalHref.length - 10);
                 }
             }
          }
    %>
    <li <%- liAttributes %>>
      <a href="<%- finalHref %>" class="<%- isActive ? 'active' : '' %>" <%- isExplicitExternal ? 'target="_blank" rel="noopener"' : '' %>>
        <% if (item.icon) { %> <%- renderIcon(item.icon) %> <% } %>
        <span class="nav-item-title"><%= item.title %></span>
        <% if (isCollapsible) { %> <%- renderIcon('chevron-right', { class: 'collapse-icon' }) %> <% } %>
        <% if (isExplicitExternal) { %> <%- renderIcon('external-link', { class: 'nav-external-icon' }) %> <% } %>
      </a>
      <% if (item.children) { %>
        <ul class="submenu" style="<%= (isCollapsible && shouldBeOpen) ? 'display: block;' : 'display: none;' %>">
          <% renderNav(item.children); %>
        </ul>
      <% } %>
    </li>
    <% }); } renderNav(navItems); %>
  </ul>
</nav>